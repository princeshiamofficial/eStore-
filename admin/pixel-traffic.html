<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta Pixel & Traffic | Color Hut Studio</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        /* Subtle Background Gradient Blob */
        .bg-blob {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50vh;
            background: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.08) 0%, rgba(255, 255, 255, 0) 70%);
            z-index: -1;
            pointer-events: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.02),
                0 2px 4px -1px rgba(0, 0, 0, 0.02),
                0 20px 25px -5px rgba(0, 0, 0, 0.03),
                0 0 0 1px rgba(0, 0, 0, 0.01);
        }

        .floating-row {
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.2s;
        }

        .floating-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            z-index: 10;
            position: relative;
        }

        .custom-toggle:checked~div {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        .custom-toggle:checked~div:after {
            transform: translateX(100%);
            border-color: white;
        }

        .sidebar-link {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .sidebar-link.active {
            background: linear-gradient(to right, #fff7ed, #fff);
            color: #ea580c;
        }

        .sidebar-link.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: #ea580c;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }

        .sidebar-link:hover:not(.active) {
            background-color: #f8fafc;
            color: #ea580c;
            padding-left: 1.25rem;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        html {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden bg-slate-50">
    <!-- Background Blob -->
    <div class="bg-blob"></div>

    <!-- Sidebar -->
    <aside id="admin-sidebar"
        class="w-64 bg-white/80 backdrop-blur-xl border-r border-slate-200/60 flex-shrink-0 flex flex-col z-20 hidden md:flex sidebar-panel">
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
        <!-- Top Navigation (Mobile) -->
        <header
            class="h-16 bg-white border-b border-slate-200 flex md:hidden items-center justify-between px-6 sticky top-0 z-20">
            <img src="/logo.png" alt="Color Hut" class="h-6">
            <button class="text-slate-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </header>

        <div class="p-6 md:p-10 max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-12">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-2">Meta Pixel & Traffic</h1>
                    <p class="text-slate-500 font-medium text-lg">Manage tracking pixels and view real-time visitor
                        insights.</p>
                </div>
                <div
                    class="flex items-center gap-2 px-4 py-2 bg-white/60 backdrop-blur-sm rounded-full border border-white/50 shadow-sm">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-slate-600 uppercase tracking-widest">System Operational</span>
                </div>
            </div>

            <!-- Configuration & Setup Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Meta Pixel Configuration -->
                <div class="glass-panel rounded-[2.5rem] p-8 relative overflow-hidden group h-full">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-bl-[4rem] -mr-8 -mt-8 z-0 transition-transform group-hover:scale-110 duration-500">
                    </div>

                    <div class="relative z-10">
                        <div class="flex items-center gap-5 mb-8">
                            <div
                                class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 flex items-center justify-center text-white">
                                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Tracking Config</h2>
                                <p class="text-sm text-slate-500 font-semibold">Meta & Google</p>
                            </div>
                        </div>

                        <form id="pixelForm" onsubmit="savePixel(event)" class="space-y-6">
                            <!-- Meta Pixel Section -->
                            <div class="space-y-3">
                                <label
                                    class="block text-xs font-black uppercase tracking-widest text-slate-400 ml-1">Meta
                                    Pixel ID</label>
                                <div class="relative">
                                    <input type="text" id="pixelId" placeholder="e.g. 1234567890"
                                        class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl py-4 px-5 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-bold text-slate-700 placeholder:text-slate-300">
                                </div>
                            </div>

                            <div class="flex items-center justify-between py-2 border-b border-slate-100 mb-4">
                                <span class="text-xs font-bold text-slate-500">Enable Pixel</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="pixelEnabled" class="sr-only peer custom-toggle">
                                    <div
                                        class="w-10 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all shadow-inner transition-colors">
                                    </div>
                                </label>
                            </div>

                            <!-- GTM Section -->
                            <div class="space-y-3 pt-2">
                                <label
                                    class="block text-xs font-black uppercase tracking-widest text-slate-400 ml-1">GTM
                                    Container ID</label>
                                <div class="relative">
                                    <input type="text" id="gtmId" placeholder="e.g. GTM-XXXXXX"
                                        class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl py-4 px-5 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-bold text-slate-700 placeholder:text-slate-300">
                                </div>
                            </div>

                            <div class="flex items-center justify-between py-2 border-b border-slate-100">
                                <span class="text-xs font-bold text-slate-500">Enable GTM</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="gtmEnabled" class="sr-only peer custom-toggle">
                                    <div
                                        class="w-10 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all shadow-inner transition-colors">
                                    </div>
                                </label>
                            </div>

                            <button type="submit"
                                class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-gradient-to-r hover:from-blue-600 hover:to-indigo-600 transition-all shadow-xl shadow-slate-900/10 hover:shadow-blue-500/25 active:scale-[0.98] mt-4">
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Setup Guide -->
                <div
                    class="bg-gradient-to-br from-blue-50 to-indigo-50/50 rounded-[2.5rem] border border-blue-100/60 p-8 h-full">
                    <h3
                        class="text-sm font-black text-blue-900 uppercase tracking-widest mb-6 border-b border-blue-200/50 pb-4">
                        Quick Setup</h3>

                    <!-- Meta Setup -->
                    <!-- Meta Setup -->
                    <div class="mb-8">
                        <h4 class="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Meta Pixel
                        </h4>
                        <ul class="space-y-4">
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-blue-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-blue-100">
                                    1</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Log in to Meta
                                    Suite and open <strong class="text-blue-900">Events Manager</strong>.</p>
                            </li>
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-blue-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-blue-100">
                                    2</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Select your Data
                                    Source (Pixel) and go to <strong class="text-blue-900">Settings</strong>.</p>
                            </li>
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-blue-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-blue-100">
                                    3</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Copy the
                                    <strong>Pixel ID</strong> (e.g. 1234567890).
                                </p>
                            </li>
                        </ul>
                    </div>

                    <!-- GTM Setup -->
                    <div>
                        <h4 class="text-xs font-bold text-indigo-600 uppercase mb-3 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> Google Tag Manager
                        </h4>
                        <ul class="space-y-4">
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-indigo-100">
                                    1</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Create an account
                                    at <strong class="text-indigo-900">tagmanager.google.com</strong>.</p>
                            </li>
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-indigo-100">
                                    2</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Select
                                    <strong>Web Container</strong> for your domain.
                                </p>
                            </li>
                            <li class="flex items-start gap-3">
                                <div
                                    class="flex-shrink-0 w-6 h-6 bg-white text-indigo-600 rounded-full flex items-center justify-center font-black text-[10px] shadow-sm border border-indigo-100">
                                    3</div>
                                <p class="text-xs font-medium text-blue-800/80 leading-relaxed pt-0.5">Copy the
                                    <strong>Container ID</strong> (GTM-XXXXXX) from the top bar.
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Traffic Sources Report -->
            <div class="w-full space-y-8">
                <div class="glass-panel rounded-[2.5rem] p-8 md:p-10 min-h-[600px]">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-10">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Traffic Sources</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Live Updates
                                </p>
                            </div>
                        </div>
                        <div class="relative group">
                            <select
                                class="appearance-none bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-xl pl-4 pr-10 py-3 outline-none hover:border-orange-300 focus:border-orange-500 transition-colors cursor-pointer shadow-sm focus:ring-4 focus:ring-orange-500/10">
                                <option>Last 30 Days</option>
                                <option>Last 7 Days</option>
                                <option>Today</option>
                            </select>
                            <div
                                class="absolute right-3 top-3.5 text-slate-400 pointer-events-none group-hover:text-orange-500 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div
                        class="relative h-80 w-full mb-12 bg-white/50 backdrop-blur-sm rounded-3xl p-4 border border-slate-100">
                        <canvas id="trafficChart"></canvas>
                    </div>

                    <!-- Modern Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-separate border-spacing-y-3">
                            <thead>
                                <tr class="text-left">
                                    <th
                                        class="pb-2 pl-6 text-[10px] font-black uppercase tracking-widest text-slate-400">
                                        Source</th>
                                    <th class="pb-2 text-[10px] font-black uppercase tracking-widest text-slate-400">
                                        Page</th>
                                    <th class="pb-2 text-[10px] font-black uppercase tracking-widest text-slate-400">
                                        IP Address</th>
                                    <th class="pb-2 text-[10px] font-black uppercase tracking-widest text-slate-400">
                                        Sessions</th>
                                    <th
                                        class="pb-2 pr-6 text-right text-[10px] font-black uppercase tracking-widest text-slate-400">
                                        Last Seen</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-4">
                                <tr class="group hover:bg-slate-50 transition-colors">
                                    <td class="py-4 pl-2 font-bold text-slate-700">Google / Organic</td>
                                    <td class="py-4 font-bold text-slate-900">1,234</td>
                                    <td class="py-4 text-slate-500">1,450</td>
                                    <td class="py-4 text-right pr-2 text-emerald-500 font-bold">+12.5%</td>
                                </tr>
                                <tr class="group hover:bg-slate-50 transition-colors">
                                    <td class="py-4 pl-2 font-bold text-slate-700">Direct / None</td>
                                    <td class="py-4 font-bold text-slate-900">856</td>
                                    <td class="py-4 text-slate-500">920</td>
                                    <td class="py-4 text-right pr-2 text-emerald-500 font-bold">+5.2%</td>
                                </tr>
                                <tr class="group hover:bg-slate-50 transition-colors">
                                    <td class="py-4 pl-2 font-bold text-slate-700">Facebook / Social</td>
                                    <td class="py-4 font-bold text-slate-900">543</td>
                                    <td class="py-4 text-slate-500">610</td>
                                    <td class="py-4 text-right pr-2 text-red-500 font-bold">-2.1%</td>
                                </tr>
                                <tr class="group hover:bg-slate-50 transition-colors">
                                    <td class="py-4 pl-2 font-bold text-slate-700">Instagram / Social</td>
                                    <td class="py-4 font-bold text-slate-900">320</td>
                                    <td class="py-4 text-slate-500">380</td>
                                    <td class="py-4 text-right pr-2 text-emerald-500 font-bold">+8.4%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Controls -->
                    <div class="flex items-center justify-between mt-6 border-t border-slate-100 pt-6">
                        <div class="text-sm text-slate-500 font-bold">
                            Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span
                                id="totalItems">0</span> results
                        </div>
                        <div class="flex gap-2">
                            <button id="prevPageBtn" onclick="changePage(-1)"
                                class="px-4 py-2 text-sm font-bold text-slate-500 bg-slate-50 rounded-xl hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Previous
                            </button>
                            <button id="nextPageBtn" onclick="changePage(1)"
                                class="px-4 py-2 text-sm font-bold text-white bg-slate-900 rounded-xl hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/assets/admin-sidebar.js?v=3"></script>
    <script src="/assets/admin-common.js"></script>
    <script>
        let trafficChart = null;
        let allSources = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Load Initial Data
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPixelConfig();
            await loadTrafficStats();
        });

        // Load Pixel & GTM Config
        async function loadPixelConfig() {
            try {
                const response = await fetch('/api/admin/settings');
                const settings = await response.json();

                document.getElementById('pixelId').value = settings.meta_pixel_id || '';
                document.getElementById('pixelEnabled').checked = settings.meta_pixel_enabled === 'true';

                document.getElementById('gtmId').value = settings.gtm_container_id || '';
                document.getElementById('gtmEnabled').checked = settings.gtm_enabled === 'true';
            } catch (err) {
                console.error('Failed to load settings', err);
            }
        }

        // Save Pixel & GTM Config
        async function savePixel(e) {
            e.preventDefault();
            const pixelId = document.getElementById('pixelId').value;
            const pixelEnabled = document.getElementById('pixelEnabled').checked;
            const gtmId = document.getElementById('gtmId').value;
            const gtmEnabled = document.getElementById('gtmEnabled').checked;

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;

            btn.innerText = 'Saving...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        meta_pixel_id: pixelId,
                        meta_pixel_enabled: pixelEnabled ? 'true' : 'false',
                        gtm_container_id: gtmId,
                        gtm_enabled: gtmEnabled ? 'true' : 'false'
                    })
                });

                if (response.ok) {
                    alert('Configuration saved successfully!');
                } else {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                alert('Error saving configuration');
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Load Traffic Stats
        async function loadTrafficStats() {
            try {
                const rangeSelector = document.querySelector('select');
                const range = rangeSelector.value === 'Today' ? 1 : (rangeSelector.value === 'Last 7 Days' ? 7 : 30);
                const response = await fetch(`/api/admin/traffic-stats?range=${range}`);
                const data = await response.json();

                renderChart(data.daily);

                allSources = data.sources;
                currentPage = 1;
                renderPaginationSource();
            } catch (err) {
                console.error('Failed to load traffic stats', err);
            }
        }

        function renderChart(dailyData) {
            const ctx = document.getElementById('trafficChart').getContext('2d');

            if (trafficChart) trafficChart.destroy();

            const labels = dailyData.map(d => new Date(d.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const values = dailyData.map(d => d.sessions);

            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sessions',
                        data: values,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#f97316',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: true, borderDash: [5, 5], color: 'rgba(0,0,0,0.05)' },
                            ticks: { precision: 0 }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function getSourceIcon(category) {
            if (category.includes('Google')) return '<div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .533 5.333.533 12S5.867 24 12.48 24c3.44 0 6.013-1.133 8.053-3.24 2.08-2.08 2.72-5.013 2.72-7.427 0-.733-.053-1.44-.147-2.133h-10.63z" /></svg></div>';
            if (category.includes('Facebook')) return '<div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.791-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" /></svg></div>';
            if (category.includes('Instagram')) return '<div class="w-8 h-8 rounded-full bg-pink-50 flex items-center justify-center text-pink-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" /></svg></div>';
            if (category.includes('Twitter')) return '<div class="w-8 h-8 rounded-full bg-sky-50 flex items-center justify-center text-sky-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" /></svg></div>';

            // Default / Direct
            return '<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></div>';
        }

        function renderTable(sources) {
            const tbody = document.querySelector('tbody');
            if (!sources || sources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-slate-400">No traffic data available yet</td></tr>';
                return;
            }

            tbody.innerHTML = sources.map(source => `
            <tr class="group hover:bg-slate-50 transition-colors">
                <td class="py-4 pl-2 font-bold text-slate-700">
                    <div class="flex items-center gap-3">
                        ${getSourceIcon(source.source_category)}
                        ${source.source_category}
                    </div>
                </td>
                <td class="py-4 text-sm font-medium text-slate-500 max-w-[200px] truncate" title="${source.path}">${source.path}</td>
                <td class="py-4 font-bold text-slate-900 font-mono text-xs">${source.ip_address}</td>
                <td class="py-4 text-slate-500">${source.sessions}</td>
                <td class="py-4 text-right pr-2 text-slate-400 text-xs text-center font-mono">
                    ${new Date(source.last_visit).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                </td>
            </tr>
            `).join('');
        }

        function renderPaginationSource() {
            const totalItems = allSources.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Validate current page logic
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const startStr = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endStr = Math.min(currentPage * itemsPerPage, totalItems);

            // UI Updates
            const startEl = document.getElementById('startRange');
            const endEl = document.getElementById('endRange');
            const totalEl = document.getElementById('totalItems');

            if (startEl) startEl.textContent = startStr;
            if (endEl) endEl.textContent = endStr;
            if (totalEl) totalEl.textContent = totalItems;

            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = allSources.slice(startIndex, endIndex);

            renderTable(paginatedItems);
        }

        function changePage(delta) {
            currentPage += delta;
            renderPaginationSource();
        }

        // Handle Range Change
        document.querySelector('select').addEventListener('change', loadTrafficStats);

        // Real-time Traffic Update

    </script>
</body>

</html>