<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products | Color Hut Studio</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .sidebar-link {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .sidebar-link.active {
            background: linear-gradient(to right, #fff7ed, #fff);
            color: #ea580c;
            border-right: 3px solid #ea580c;
        }

        .sidebar-link:hover:not(.active) {
            background-color: #f8fafc;
            color: #ea580c;
            padding-left: 1.25rem;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        html {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .dragging {
            opacity: 0.5;
            border: 2px dashed #f97316;
        }

        .drag-over {
            border: 2px solid #f97316;
            transform: scale(1.05);
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden bg-slate-50">

    <!-- Sidebar -->
    <aside id="admin-sidebar"
        class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col z-20 hidden md:flex"></aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
        <!-- Top Navigation (Mobile) -->
        <header
            class="h-16 bg-white border-b border-slate-200 flex md:hidden items-center justify-between px-6 sticky top-0 z-20">
            <img src="/logo.png" alt="Color Hut" class="h-6">
            <button class="text-slate-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </header>

        <div class="p-6 md:p-10 max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-10">
                <div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2">Products</h1>
                    <p class="text-slate-500 font-medium">Manage your product catalog.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openProductModal()"
                        class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-orange-600 transition-colors shadow-lg shadow-slate-900/10 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        New Product
                    </button>
                </div>
            </div>

            <!-- Products Table -->
            <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/50 p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div class="relative w-full md:w-96">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="searchInput"
                            class="block w-full pl-11 pr-4 py-3 border border-slate-200 rounded-xl leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 sm:text-sm font-bold transition-all"
                            placeholder="Search products...">
                    </div>

                    <div class="flex gap-4">
                        <select id="categoryFilter"
                            class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-orange-500 focus:border-orange-500 block px-4 py-3 font-bold outline-none cursor-pointer">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="statusFilter"
                            class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-orange-500 focus:border-orange-500 block px-4 py-3 font-bold outline-none cursor-pointer">
                            <option value="all">All Status</option>
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="productsTable">
                        <thead>
                            <tr
                                class="text-left text-xs font-black uppercase tracking-widest text-slate-400 border-b border-slate-100">
                                <th class="pb-4 pl-4 w-10"></th>
                                <th class="pb-4 pl-4">Product</th>
                                <th class="pb-4">Category</th>
                                <th class="pb-4 text-center">Video</th>
                                <th class="pb-4">Status</th>
                                <th class="pb-4 text-center">Pin</th>
                                <th class="pb-4 pr-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Pagination Controls -->
            <div class="flex items-center justify-between mt-6 border-t border-slate-100 pt-6">
                <div class="text-sm text-slate-500 font-bold">
                    Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span
                        id="totalItems">0</span> results
                </div>
                <div class="flex gap-2">
                    <button id="prevPageBtn" onclick="changePage(-1)"
                        class="px-4 py-2 text-sm font-bold text-slate-500 bg-slate-50 rounded-xl hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Previous
                    </button>
                    <button id="nextPageBtn" onclick="changePage(1)"
                        class="px-4 py-2 text-sm font-bold text-white bg-slate-900 rounded-xl hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Next
                    </button>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="productModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] max-w-2xl w-full p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 id="modalTitle" class="text-2xl font-black text-slate-900 mb-6">New Product</h2>
            <form id="productForm" onsubmit="saveProduct(event)" class="space-y-4">
                <input type="hidden" id="productId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">Product
                            Name</label>
                        <input type="text" id="productName" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 outline-none focus:border-orange-500 focus:bg-white text-slate-800 font-medium">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">Category</label>
                        <select id="productCategory" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 outline-none focus:border-orange-500 focus:bg-white text-slate-800 font-medium cursor-pointer">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <input type="hidden" id="productPosition" value="0">

                    <!-- Status -->
                    <div>
                        <label
                            class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2 ml-1">Status</label>
                        <div class="relative">
                            <select id="productStatus"
                                class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3 px-4 outline-none focus:border-orange-500 font-bold text-slate-700 appearance-none">
                                <option value="Draft">Draft</option>
                                <option value="Published">Published</option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="productRating" value="5">
                    <!-- SEO Keywords -->
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2 ml-1">SEO
                            Keywords (Comma separated)</label>
                        <input type="text" id="productSeoKeywords"
                            placeholder="e.g. premium, design, studio, minimalist"
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3 px-4 outline-none focus:border-orange-500 font-bold text-slate-700 placeholder:text-slate-400">
                    </div>
                    <!-- SEO Description -->
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2 ml-1">SEO
                            Description (Meta Description)</label>
                        <textarea id="productSeoDescription" placeholder="A brief summary for Google search results..."
                            class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3 px-4 outline-none focus:border-orange-500 font-bold text-slate-700 placeholder:text-slate-400 resize-none h-24"></textarea>
                    </div>
                    <input type="hidden" id="productIsPinned" value="0">
                    <div class="md:col-span-2">
                        <div class="bg-slate-100/50 rounded-[2rem] p-4 border border-slate-200">
                            <!-- Google Docs Style Toolbar -->
                            <div
                                class="flex flex-wrap items-center gap-1 bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm mb-4 sticky top-0 z-10">
                                <button type="button" id="togglePreviewBtn" onclick="toggleDescriptionPreview()"
                                    class="px-4 py-2 text-[11px] font-black uppercase tracking-widest text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all flex items-center gap-2 border-r border-slate-100 pr-4 mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2.5" />
                                        <path
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    Preview
                                </button>

                                <button type="button" onclick="insertMarkdown('bold')"
                                    class="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all"
                                    title="Bold (Ctrl+B)">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z" stroke-width="3" />
                                        <path d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z" stroke-width="3" />
                                    </svg>
                                </button>
                                <button type="button" onclick="insertMarkdown('italic')"
                                    class="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all"
                                    title="Italic (Ctrl+I)">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 4L10 20M14 4H21M3 20H10" stroke-width="3" stroke-linecap="round" />
                                    </svg>
                                </button>
                                <div class="w-px h-6 bg-slate-100 mx-2"></div>
                                <button type="button" onclick="insertMarkdown('heading')"
                                    class="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all"
                                    title="Add Heading">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 4V20M18 4V20M6 12H18" stroke-width="3" stroke-linecap="round" />
                                    </svg>
                                </button>
                                <button type="button" onclick="insertMarkdown('list')"
                                    class="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all"
                                    title="Bulleted List">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke-width="3"
                                            stroke-linecap="round" />
                                    </svg>
                                </button>
                                <div class="w-px h-6 bg-slate-100 mx-2"></div>
                                <button type="button" onclick="insertMarkdown('link')"
                                    class="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all"
                                    title="Insert Link">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101"
                                            stroke-width="2.5" stroke-linecap="round" />
                                        <path d="M10.172 13.828a4 4 0 005.656 0l4-4a4 4 0 10-5.656-5.656l-1.102 1.101"
                                            stroke-width="2.5" stroke-linecap="round" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Document Style Page -->
                            <div
                                class="relative max-w-[800px] mx-auto bg-white rounded-xl shadow-inner border border-slate-200/60 overflow-hidden group/doc">
                                <textarea id="productDescription" oninput="updateDescriptionPreview()"
                                    placeholder="Start crafting your premium product story..."
                                    style="font-family: 'Inter', sans-serif;"
                                    class="w-full min-h-[400px] p-10 md:p-14 outline-none resize-none text-slate-700 text-lg leading-relaxed scrollbar-hide bg-transparent selection:bg-orange-100 selection:text-orange-900"></textarea>
                                <div id="descriptionPreview"
                                    class="hidden min-h-[400px] p-10 md:p-14 bg-white text-slate-800 text-lg leading-relaxed overflow-y-auto scrollbar-hide">
                                </div>

                                <div
                                    class="absolute bottom-4 right-6 pointer-events-none transition-opacity opacity-0 group-hover/doc:opacity-100">
                                    <span
                                        class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Document
                                        Editor v1.0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">Product
                            Images</label>
                        <div id="dropZone"
                            class="relative border-2 border-dashed border-slate-200 rounded-[1.5rem] p-8 flex flex-col items-center justify-center gap-4 hover:border-orange-500 hover:bg-orange-50/30 transition-all cursor-pointer group">
                            <input type="file" id="imageInput" class="hidden" accept="image/*" multiple>

                            <div id="uploadPlaceholder" class="flex flex-col items-center">
                                <div
                                    class="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-600 mb-4 group-hover:scale-110 transition-transform">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <p class="text-slate-900 font-bold">Drag & drop or <span
                                        class="text-orange-600 underline">click to
                                        upload</span></p>
                                <p class="text-slate-400 text-sm font-medium">Add multiple PNG, JPG or WEBP (Max 5MB
                                    each)</p>
                            </div>

                            <div id="imagePreviewGrid" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 w-full mt-4">
                                <!-- Previews will be injected here -->
                            </div>
                        </div>
                    </div>


                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">Video URL
                            (Optional)</label>
                        <input type="url" id="productVideo" placeholder="https://youtube.com/..."
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 outline-none focus:border-orange-500 focus:bg-white text-slate-800 font-medium">
                    </div>
                </div>
                <div class="flex gap-3 pt-6">
                    <button type="button" onclick="closeProductModal()"
                        class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition-colors">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] max-w-md w-full p-8 shadow-2xl">
            <h2 class="text-2xl font-black text-slate-900 mb-4">Delete Product?</h2>
            <p class="text-slate-600 mb-6 font-medium">This action cannot be undone. This product will be permanently
                removed from your catalog.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()"
                    class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteBtn"
                    class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script src="/assets/admin-sidebar.js?v=3"></script>
    <script src="/assets/admin-common.js"></script>
    <script>
        let products = [];
        let categories = [];
        let deleteId = null;
        let uploadedImages = [];
        let sortableInstance = null;
        let currentPage = 1;
        const itemsPerPage = 12;



        // Image Upload Logic
        const dropZone = document.getElementById('dropZone');
        const imageInput = document.getElementById('imageInput');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const imagePreviewGrid = document.getElementById('imagePreviewGrid');

        dropZone.onclick = (e) => {
            if (e.target.closest('button')) return;
            imageInput.click();
        };

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('border-orange-500', 'bg-orange-50/50');
        };

        dropZone.ondragleave = () => {
            dropZone.classList.remove('border-orange-500', 'bg-orange-50/50');
        };

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-orange-500', 'bg-orange-50/50');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFileUpload(files);
        };

        imageInput.onchange = (e) => {
            if (e.target.files.length > 0) handleFileUpload(e.target.files);
        };

        async function handleFileUpload(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                if (files[i].type.startsWith('image/')) {
                    formData.append('images', files[i]);
                }
            }

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.imageUrls) {
                    data.imageUrls.forEach(url => {
                        uploadedImages.push(url);
                    });
                    renderImagePreviews();
                }
            } catch (err) {
                console.error('Upload failed:', err);
                alert('Upload failed');
            }
        }

        function renderImagePreviews() {
            if (uploadedImages.length > 0) {
                uploadPlaceholder.classList.add('hidden');
                imagePreviewGrid.classList.remove('hidden');
                imagePreviewGrid.innerHTML = uploadedImages.map((url, index) => `
                    <div class="relative group/item aspect-square rounded-xl overflow-hidden shadow-sm border border-slate-100 cursor-move transition-all duration-200"
                        draggable="true"
                        data-index="${index}"
                        ondragstart="handleDragStart(event)"
                        ondragover="handleDragOver(event)"
                        ondrop="handleDrop(event)"
                        ondragenter="handleDragEnter(event)"
                        ondragleave="handleDragLeave(event)"
                        ondragend="handleDragEnd(event)">
                        <img src="${url}" class="w-full h-full object-cover pointer-events-none">
                        <button type="button" onclick="removeImage(event, ${index})" 
                            class="absolute top-2 right-2 bg-red-600 text-white p-1.5 rounded-lg opacity-0 group-hover/item:opacity-100 transition-opacity hover:bg-red-700 shadow-lg cursor-pointer">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <div class="absolute bottom-2 left-2 bg-black/50 text-white text-[10px] font-bold px-2 py-1 rounded backdrop-blur-sm pointer-events-none">
                            ${index + 1}
                        </div>
                    </div>
                `).join('');
            } else {
                uploadPlaceholder.classList.remove('hidden');
                imagePreviewGrid.classList.add('hidden');
                imagePreviewGrid.innerHTML = '';
            }
        }

        // Drag and Drop Logic
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.index);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.target.closest('div[draggable]').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.closest('div[draggable]').classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('#imagePreviewGrid > div').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); // stops the browser from redirecting.
            }

            const target = e.target.closest('div[draggable]');
            if (dragSrcEl !== target) {
                const oldIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const newIndex = parseInt(target.dataset.index);

                // Reorder array
                const movedItem = uploadedImages.splice(oldIndex, 1)[0];
                uploadedImages.splice(newIndex, 0, movedItem);

                renderImagePreviews();
            }

            return false;
        }

        function removeImage(e, index) {
            if (e) e.stopPropagation();
            if (index !== undefined) {
                uploadedImages.splice(index, 1);
            } else {
                uploadedImages = [];
            }
            renderImagePreviews();
        }

        // Initial Load
        async function init() {
            await Promise.all([
                loadCategories(),
                loadProducts()
            ]);

            // Initialize Modern Dropdowns
            createModernDropdown('categoryFilter');
            createModernDropdown('statusFilter');
            createModernDropdown('productCategory');
            createModernDropdown('productStatus');
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                categories = await response.json();

                const filter = document.getElementById('categoryFilter');
                const dropdown = document.getElementById('productCategory');

                filter.innerHTML = '<option value="all">All Categories</option>';
                dropdown.innerHTML = '<option value="">Select Category</option>';

                // Inclusive hierarchical display
                const addedIds = new Set();
                const mainCategories = categories.filter(c => !c.parent_ids);

                mainCategories.forEach(main => {
                    if (!addedIds.has(main.id)) {
                        filter.innerHTML += `<option value="${main.id}">${main.name}</option>`;
                        dropdown.innerHTML += `<option value="${main.id}">${main.name}</option>`;
                        addedIds.add(main.id);
                    }

                    const subs = categories.filter(c => {
                        const pIds = c.parent_ids ? c.parent_ids.split(',').map(Number) : [];
                        return pIds.includes(main.id);
                    });

                    subs.forEach(sub => {
                        if (!addedIds.has(sub.id)) {
                            filter.innerHTML += `<option value="${sub.id}">-- ${sub.name}</option>`;
                            dropdown.innerHTML += `<option value="${sub.id}">-- ${sub.name}</option>`;
                            addedIds.add(sub.id);
                        }
                    });
                });

                // Fail-safe: Ensure all categories are visible even if they are orphaned or multi-level
                categories.forEach(cat => {
                    if (!addedIds.has(cat.id)) {
                        const prefix = cat.parent_ids ? '-- ' : '';
                        filter.innerHTML += `<option value="${cat.id}">${prefix}${cat.name}</option>`;
                        dropdown.innerHTML += `<option value="${cat.id}">${prefix}${cat.name}</option>`;
                        addedIds.add(cat.id);
                    }
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                products = await response.json();
                applyFilters();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function renderProducts(items) {
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = items.map(product => {
                let images = [];
                try {
                    images = product.image ? (product.image.startsWith('[') ? JSON.parse(product.image) : [product.image]) : [];
                } catch (e) { images = [product.image]; }
                const mainImage = images[0] || 'https://via.placeholder.com/100';

                return `
                <tr class="group hover:bg-slate-50/50 transition-colors" data-id="${product.id}">
                    <td class="py-4 pl-4">
                        <div class="drag-handle w-6 h-6 bg-slate-100 rounded text-slate-400 flex items-center justify-center cursor-move hover:bg-slate-200 hover:text-slate-600 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 8h16M4 16h16" stroke-width="2.5" stroke-linecap="round" /></svg>
                        </div>
                    </td>
                    <td class="py-4 pl-4">
                        <div class="flex items-center gap-4">
                            <img src="${mainImage}" class="w-12 h-12 rounded-xl object-cover border border-slate-100" alt="Product">
                            <div>
                                <div class="font-bold text-slate-900">${product.name}</div>
                                <div class="flex items-center gap-2">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">#${product.id.toString().padStart(4, '0')}</div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4">
                        <span class="text-sm font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded-lg">${product.category_name || 'Uncategorized'}</span>
                    </td>
                    <td class="py-4 text-center">
                        ${product.video_url ? `
                            <a href="${product.video_url}" target="_blank" class="inline-flex items-center justify-center p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.254,4,12,4,12,4S5.746,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.746,2,11,2,11s0,3.254,0.418,4.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.746,18,12,18,12,18s6.254,0,7.814-0.418c0.86-0.23,1.538-0.908,1.768-1.768C22,14.254,22,11,22,11S22,7.746,21.582,6.186z M10,14.5v-7l6,3.5L10,14.5z" />
                                </svg>
                            </a>
                        ` : '<span class="text-slate-300 font-bold text-xs uppercase tracking-widest">N/A</span>'}
                    </td>
                    <td class="py-4">
                        <span class="${product.status === 'Published' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'} font-bold text-[10px] uppercase tracking-widest px-2.5 py-1 rounded-lg">
                            ${product.status}
                        </span>
                    </td>
                    <td class="py-4 text-center">
                        <button onclick="toggleProductPin(${product.id}, ${product.is_pinned})" 
                            class="p-2 rounded-lg transition-all ${product.is_pinned ? 'text-orange-500 bg-orange-50' : 'text-slate-300 hover:text-slate-400'}">
                            <svg class="w-5 h-5" fill="${product.is_pinned ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v11l-4 4-4-4V5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </td>
                    <td class="py-4 pr-4 text-right">
                        <div class="flex justify-end gap-2">
                             <button type="button" onclick="editProduct(event, ${product.id})" class="p-2 text-slate-400 hover:text-orange-600 transition-colors focus:outline-none">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                            <button type="button" onclick="openDeleteModal(event, ${product.id})" class="p-2 text-slate-400 hover:text-red-600 transition-colors focus:outline-none">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = products;

            if (category !== 'all') {
                filtered = filtered.filter(p => p.category_id == category);
            }
            if (status !== 'all') {
                filtered = filtered.filter(p => p.status === status);
            }
            if (search) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(search) ||
                    (p.description && p.description.toLowerCase().includes(search))
                );
            }

            renderPagination(filtered);
        }

        function renderPagination(filteredItems) {
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Validate current page
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const startStr = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endStr = Math.min(currentPage * itemsPerPage, totalItems);

            document.getElementById('startRange').textContent = startStr;
            document.getElementById('endRange').textContent = endStr;
            document.getElementById('totalItems').textContent = totalItems;

            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredItems.slice(startIndex, endIndex);

            renderProducts(paginatedItems);
            initSortable();
        }

        function changePage(delta) {
            currentPage += delta;
            applyFilters();
        }

        function initSortable() {
            const tbody = document.querySelector('#productsTable tbody');
            if (sortableInstance) sortableInstance.destroy();

            sortableInstance = Sortable.create(tbody, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'bg-orange-50',
                onEnd: async function () {
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const orders = rows.map((row, index) => ({
                        id: parseInt(row.dataset.id),
                        position: index
                    }));

                    // Optimistic update
                    orders.forEach(o => {
                        const p = products.find(prod => prod.id === o.id);
                        if (p) p.position = o.position;
                    });

                    try {
                        const response = await fetch('/api/products/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orders })
                        });

                        if (!response.ok) loadProducts(); // Revert on error
                    } catch (e) {
                        console.error('Reorder failed', e);
                        loadProducts();
                    }
                }
            });
        }

        // CRUD Operations
        function openProductModal() {
            document.getElementById('modalTitle').innerText = 'New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            uploadedImages = [];
            renderImagePreviews();
            document.getElementById('productRating').value = 5;
            document.getElementById('productPosition').value = 0;
            document.getElementById('productIsPinned').value = '0';
            updatePinUI(false);
            document.getElementById('productSeoKeywords').value = '';
            document.getElementById('productSeoDescription').value = '';
            document.getElementById('productModal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('productName').value,
                category_id: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                image: JSON.stringify(uploadedImages),
                video_url: document.getElementById('productVideo').value,
                status: document.getElementById('productStatus').value,
                rating: document.getElementById('productRating').value,
                seo_keywords: document.getElementById('productSeoKeywords').value,
                seo_description: document.getElementById('productSeoDescription').value,
                position: document.getElementById('productPosition').value,
                is_pinned: document.getElementById('productIsPinned').value === '1'
            };

            try {
                const url = id ? `/api/products/${id}` : '/api/products';
                const method = id ? 'PUT' : 'POST';
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeProductModal();
                    loadProducts();
                } else {
                    const err = await response.json();
                    alert('Error: ' + err.error);
                }
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        function editProduct(e, id) {
            if (e) e.stopPropagation();
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('modalTitle').innerText = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category_id || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productVideo').value = product.video_url || '';
            document.getElementById('productStatus').value = product.status;
            document.getElementById('productRating').value = product.rating || 5;
            document.getElementById('productPosition').value = product.position || 0;
            document.getElementById('productSeoKeywords').value = product.seo_keywords || '';
            document.getElementById('productSeoDescription').value = product.seo_description || '';
            document.getElementById('productIsPinned').value = product.is_pinned ? '1' : '0';
            updatePinUI(product.is_pinned);

            try {
                uploadedImages = product.image ? (product.image.startsWith('[') ? JSON.parse(product.image) : [product.image]) : [];
            } catch (e) {
                uploadedImages = [product.image].filter(Boolean);
            }
            renderImagePreviews();

            document.getElementById('productModal').classList.remove('hidden');
        }

        function openDeleteModal(e, id) {
            if (e) e.stopPropagation();
            deleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        function toggleDescriptionPreview() {
            const textarea = document.getElementById('productDescription');
            const preview = document.getElementById('descriptionPreview');
            const btn = document.getElementById('togglePreviewBtn');
            const isPreview = preview.classList.contains('hidden');

            if (isPreview) {
                preview.innerHTML = parseMarkdownDescription(textarea.value) || '<div class="flex flex-col items-center justify-center p-20 text-slate-300 select-none"><svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="text-sm font-bold uppercase tracking-widest">No Content to Preview</span></div>';
                textarea.classList.add('hidden');
                preview.classList.remove('hidden');
                btn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Edit Mode
                `;
                btn.classList.add('text-orange-600', 'bg-orange-50');
            } else {
                textarea.classList.remove('hidden');
                preview.classList.add('hidden');
                btn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2.5"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Preview Mode
                `;
                btn.classList.remove('text-orange-600', 'bg-orange-50');
                textarea.focus();
            }
        }

        function updateDescriptionPreview() {
            const textarea = document.getElementById('productDescription');
            const preview = document.getElementById('descriptionPreview');
            if (preview && !preview.classList.contains('hidden')) {
                preview.innerHTML = parseMarkdownDescription(textarea.value) || '<div class="flex flex-col items-center justify-center p-20 text-slate-300 select-none"><svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="text-sm font-bold uppercase tracking-widest">No Content to Preview</span></div>';
            }
        }

        function parseMarkdownDescription(text) {
            if (!text) return '';
            return text
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-extrabold text-slate-900 mt-6 mb-3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-black text-slate-900 mt-8 mb-4 border-b border-slate-100 pb-2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-4xl font-black text-slate-900 mt-10 mb-6">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-extrabold text-slate-900">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic text-slate-600">$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono text-orange-600">$1</code>')
                .replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank" class="text-orange-600 underline font-bold hover:text-orange-700 transition-colors">$1</a>')
                .split('\n\n').map(para => {
                    if (para.trim().startsWith('-')) {
                        const items = para.split('\n').filter(line => line.trim().startsWith('-'))
                            .map(line => `<li class="ml-4 mb-2 pl-2 relative before:content-[\'\\2022\'] before:absolute before:left-[-1rem] before:text-orange-500 before:font-black">${line.trim().substring(1).trim()}</li>`).join('');
                        return `<ul class="my-6 space-y-1">${items}</ul>`;
                    }
                    if (para.trim().startsWith('<')) return para;
                    return `<p class="mb-6 leading-loose text-slate-600 font-medium">${para.replace(/\n/g, '<br>')}</p>`;
                }).join('');
        }

        function insertMarkdown(type) {
            const textarea = document.getElementById('productDescription');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            let replacement = '';

            switch (type) {
                case 'bold':
                    replacement = `**${selectedText || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText || 'italic text'}*`;
                    break;
                case 'heading':
                    replacement = `### ${selectedText || 'Heading'}`;
                    break;
                case 'list':
                    replacement = `\n- ${selectedText || 'list item'}`;
                    break;
                case 'link':
                    replacement = `[${selectedText || 'link text'}](https://)`;
                    break;
            }

            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + (type === 'list' ? 3 : 0), start + replacement.length);
            updateDescriptionPreview();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteId) return;
            try {
                const response = await fetch(`/api/products/${deleteId}`, { method: 'DELETE' });
                if (response.ok) {
                    closeDeleteModal();
                    loadProducts();
                }
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        });


        function updatePinUI(isPinned) {
            const btn = document.getElementById('productPinBtn');
            const text = document.getElementById('pinStatusText');
            const icon = document.getElementById('pinIcon');

            if (!btn || !text || !icon) return;

            if (isPinned) {
                btn.classList.add('border-orange-500', 'bg-orange-50');
                text.innerText = 'Pinned to Home';
                text.classList.add('text-orange-600');
                icon.classList.add('text-orange-500');
                icon.setAttribute('fill', 'currentColor');
            } else {
                btn.classList.remove('border-orange-500', 'bg-orange-50');
                text.innerText = 'Not Pinned';
                text.classList.remove('text-orange-600');
                icon.classList.remove('text-orange-500');
                icon.setAttribute('fill', 'none');
            }
        }

        async function toggleProductPin(id, currentStatus) {
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...products.find(p => p.id === id),
                        is_pinned: !currentStatus
                    })
                });
                if (response.ok) loadProducts();
            } catch (error) {
                console.error('Error toggling pin:', error);
            }
        }

        document.getElementById('productForm').onsubmit = saveProduct;
        document.getElementById('searchInput').oninput = applyFilters;
        document.getElementById('categoryFilter').onchange = applyFilters;
        document.getElementById('statusFilter').onchange = applyFilters;

        init();
    </script>
</body>

</html>